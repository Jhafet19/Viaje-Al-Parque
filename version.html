<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorias de Asfalto - Juego Completo</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
            line-height: 1.4;
        }
        
        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
        }
        
        /* Pantalla de inicio */
        .title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), 
                        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><rect fill="%23111" width="1200" height="800"/><circle fill="%23333" cx="200" cy="200" r="3"/><circle fill="%23444" cx="800" cy="300" r="2"/><circle fill="%23333" cx="1000" cy="600" r="4"/><circle fill="%23555" cx="400" cy="700" r="2"/></svg>');
            background-size: cover;
            z-index: 1000;
        }
        
        .game-title {
            font-family: 'Bebas Neue', cursive;
            font-size: clamp(3rem, 8vw, 6rem);
            color: #ff6b35;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5), 0 0 40px rgba(255, 107, 53, 0.3);
            margin-bottom: 1rem;
            letter-spacing: 4px;
            text-align: center;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            from { text-shadow: 0 0 20px rgba(255, 107, 53, 0.5), 0 0 40px rgba(255, 107, 53, 0.3); }
            to { text-shadow: 0 0 30px rgba(255, 107, 53, 0.8), 0 0 60px rgba(255, 107, 53, 0.5); }
        }
        
        .game-subtitle {
            font-size: clamp(1rem, 2.5vw, 1.5rem);
            color: #cccccc;
            margin-bottom: 3rem;
            text-align: center;
            max-width: 600px;
            font-style: italic;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.5);
        }
        
        /* Interfaz principal del juego */
        .game-interface {
            display: none;
            width: 100%;
            height: 100%;
            grid-template-areas: 
                "header header header"
                "sidebar main map"
                "sidebar main map";
            grid-template-columns: 300px 1fr 250px;
            grid-template-rows: 80px 1fr;
            gap: 10px;
            padding: 10px;
        }
        
        .game-header {
            grid-area: header;
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border: 1px solid #333;
        }
        
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.8rem;
            color: #ff6b35;
            letter-spacing: 2px;
        }
        
        .chapter-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .chapter-display {
            font-family: 'Courier Prime', monospace;
            font-size: 1.1rem;
            color: #f39c12;
            font-weight: bold;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            width: 200px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f39c12);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .mental-state {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stress-bar {
            width: 100px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .sidebar {
            grid-area: sidebar;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }
        
        .main-content {
            grid-area: main;
            background: rgba(0,0,0,0.85);
            border-radius: 10px;
            padding: 30px;
            border: 1px solid #333;
            overflow-y: auto;
            position: relative;
        }
        
        .map-panel {
            grid-area: map;
            background: rgba(0,0,0,0.9);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #333;
        }
        
        .panel {
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #333;
        }
        
        .panel-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.4rem;
            color: #ff6b35;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 1px;
        }
        
        /* Sistema de reputaci√≥n */
        .reputation-item {
            margin: 12px 0;
        }
        
        .reputation-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: #ccc;
        }
        
        .reputation-bar {
            width: 100%;
            height: 10px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #444;
        }
        
        .rep-fill {
            height: 100%;
            transition: width 0.6s ease;
            border-radius: 5px;
        }
        
        .rep-police { background: linear-gradient(90deg, #3498db, #2980b9); }
        .rep-media { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .rep-citizens { background: linear-gradient(90deg, #27ae60, #229954); }
        .rep-gangs { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .rep-government { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        
        /* Contenido principal */
        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        
        .location-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 2.5rem;
            color: #ff6b35;
            letter-spacing: 2px;
        }
        
        .story-content {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: justify;
            color: #e0e0e0;
        }
        
        .inner-thought {
            background: rgba(255, 107, 53, 0.1);
            border-left: 4px solid #ff6b35;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #f39c12;
        }
        
        .dialogue {
            background: rgba(52, 73, 94, 0.3);
            border-left: 4px solid #3498db;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .revelation {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .story-update {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border-left: 3px solid #ff6b35;
            border-radius: 0 5px 5px 0;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .choices-container {
            margin-top: 30px;
        }
        
        .choices-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.3rem;
            color: #ccc;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }
        
        .choice-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            border: 2px solid #444;
            padding: 18px 25px;
            margin: 12px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1rem;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 53, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .choice-btn:hover::before {
            left: 100%;
        }
        
        .choice-btn:hover {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border-color: #ff6b35;
            transform: translateX(8px);
        }
        
        .choice-btn.critical {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            animation: criticalPulse 2s infinite;
        }
        
        @keyframes criticalPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.8); }
        }
        
        .choice-btn.critical:hover {
            border-color: #ff6b35;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .choice-consequence {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Inventario */
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .inventory-item {
            background: #333;
            border: 2px solid #444;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .inventory-item:hover {
            border-color: #ff6b35;
            background: #444;
        }
        
        .inventory-item.critical {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            animation: glow-red 3s infinite;
        }
        
        @keyframes glow-red {
            0%, 100% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 15px rgba(231, 76, 60, 0.8); }
        }
        
        /* Controles de audio */
        .audio-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 100;
        }
        
        .audio-btn {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 8px 12px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .audio-btn:hover {
            background: #555;
        }
        
        .audio-btn.active {
            background: #ff6b35;
            border-color: #ff6b35;
        }
        
        /* Finales */
        .ending-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.95));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            z-index: 200;
            animation: fadeIn 1s ease;
        }
        
        .ending-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            color: #ff6b35;
            margin-bottom: 20px;
            letter-spacing: 3px;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        .ending-content {
            max-width: 800px;
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 30px;
        }
        
        .ending-stats {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid #ff6b35;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-width: 600px;
        }
        
        .restart-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px;
        }
        
        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .game-interface {
                grid-template-areas: 
                    "header header"
                    "main main"
                    "sidebar map";
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 80px 1fr auto;
            }
            
            .chapter-info {
                flex-direction: row;
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .game-interface {
                grid-template-areas: 
                    "header"
                    "main"
                    "sidebar"
                    "map";
                grid-template-columns: 1fr;
                grid-template-rows: 80px 1fr auto auto;
            }
            
            .sidebar {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .panel {
                min-width: 250px;
            }
            
            .chapter-info {
                flex-direction: column;
                gap: 5px;
            }
            
            .progress-bar {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Pantalla de t√≠tulo -->
        <div id="titleScreen" class="title-screen">
            <h1 class="game-title">Memorias de Asfalto</h1>
            <p class="game-subtitle">
                Un thriller psicol√≥gico en las calles de una ciudad que nunca olvida.<br>
                Cada decisi√≥n tiene consecuencias. Cada recuerdo esconde una verdad.<br>
                <strong>¬øPodr√°s descubrir qu√© pas√≥ con Carlos?</strong>
            </p>
            <button class="start-btn" onclick="startGame()">Iniciar Investigaci√≥n</button>
        </div>
        
        <!-- Interfaz principal del juego -->
        <div id="gameInterface" class="game-interface">
            <!-- Header -->
            <div class="game-header">
                <div class="header-title">Memorias de Asfalto</div>
                <div class="chapter-info">
                    <div class="chapter-display" id="chapterDisplay">Cap√≠tulo 1: El Regreso</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
                <div class="mental-state">
                    <span>Estr√©s:</span>
                    <div class="stress-bar">
                        <div id="stressBar" class="stress-fill" style="width: 20%"></div>
                    </div>
                    <span id="stressValue">20%</span>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Panel de reputaci√≥n -->
                <div class="panel">
                    <h3 class="panel-title">Reputaci√≥n</h3>
                    <div class="reputation-item">
                        <div class="reputation-label">
                            <span>Polic√≠a</span>
                            <span id="policeValue">50</span>
                        </div>
                        <div class="reputation-bar">
                            <div id="policeBar" class="rep-fill rep-police" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="reputation-item">
                        <div class="reputation-label">
                            <span>Medios</span>
                            <span id="mediaValue">50</span>
                        </div>
                        <div class="reputation-bar">
                            <div id="mediaBar" class="rep-fill rep-media" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="reputation-item">
                        <div class="reputation-label">
                            <span>Ciudadanos</span>
                            <span id="citizensValue">50</span>
                        </div>
                        <div class="reputation-bar">
                            <div id="citizensBar" class="rep-fill rep-citizens" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="reputation-item">
                        <div class="reputation-label">
                            <span>Pandillas</span>
                            <span id="gangsValue">50</span>
                        </div>
                        <div class="reputation-bar">
                            <div id="gangsBar" class="rep-fill rep-gangs" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="reputation-item">
                        <div class="reputation-label">
                            <span>Gobierno</span>
                            <span id="governmentValue">50</span>
                        </div>
                        <div class="reputation-bar">
                            <div id="governmentBar" class="rep-fill rep-government" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de evidencias -->
                <div class="panel">
                    <h3 class="panel-title">Evidencias</h3>
                    <div id="inventory" class="inventory-grid"></div>
                </div>
            </div>
            
            <!-- Contenido principal -->
            <div class="main-content" id="mainContent">
                <div class="location-header">
                    <h2 id="locationTitle" class="location-title">Cargando...</h2>
                </div>
                <div id="storyContent" class="story-content"></div>
                <div id="choicesContainer" class="choices-container"></div>
            </div>
            
            <!-- Panel del mapa -->
            <div class="map-panel">
                <h3 class="panel-title">Progreso de Investigaci√≥n</h3>
                <div id="investigationProgress" style="font-size: 0.9rem; color: #ccc;">
                    <div style="margin-bottom: 10px;">
                        <strong>Pistas encontradas:</strong> <span id="clueCount">0</span>/15
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Verdad revelada:</strong> <span id="truthProgress">0</span>%
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Cap√≠tulo actual:</strong> <span id="currentChapter">1</span>/5
                    </div>
                    <div style="border-top: 1px solid #444; padding-top: 15px;">
                        <div style="font-size: 0.8rem; color: #888;">
                            <div>üîç Investigando</div>
                            <div>üí° Pista cr√≠tica</div>
                            <div>‚ö†Ô∏è Decisi√≥n importante</div>
                            <div>üéØ Objetivo completado</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controles de audio -->
        <div class="audio-controls">
            <button id="musicToggle" class="audio-btn active" onclick="toggleMusic()">üéµ M√∫sica</button>
            <button id="volumeBtn" class="audio-btn" onclick="changeVolume()">üîä Vol</button>
        </div>
    </div>

    <script>
        // Estado global del juego
        let gameState = {
            currentChapter: 1,
            currentScene: 0,
            progress: 0,
            stress: 20,
            reputation: {
                police: 50,
                media: 50,
                citizens: 50,
                gangs: 50,
                government: 50
            },
            inventory: [],
            cluesFound: 0,
            truthRevealed: 0,
            flags: {},
            choices: [],
            musicEnabled: true,
            volume: 0.3,
            gameStarted: false
        };

        // Cap√≠tulos del juego con historia completa
        const gameChapters = {
            1: {
                title: "El Regreso",
                scenes: [
                    {
                        location: "Terminal de Autobuses",
                        description: "El aire espeso de la terminal me golpea como un pu√±o. Diez a√±os fuera de esta ciudad, pero el olor a diesel, sudor y esperanza perdida sigue siendo el mismo. Los altavoces anuncian destinos que una vez so√±√© alcanzar, pero ahora solo hay uno que importa: encontrar a Carlos.",
                        thoughts: "Han pasado diez a√±os desde que me fui. Diez a√±os tratando de olvidar este lugar, y ahora estoy de vuelta por Carlos. Su √∫ltima llamada sonaba desesperada... '¬øAdri√°n? Necesito tu ayuda, hermano. Hay algo grande aqu√≠, algo que no puedo manejar solo.' Eso fue hace una semana. Desde entonces, silencio.",
                        choices: [
                            {
                                text: "Ir directamente a la comisar√≠a para reportar la desaparici√≥n",
                                consequences: "Oficial pero arriesgado. La polic√≠a podr√≠a estar involucrada.",
                                action: () => {
                                    addClue("Primera impresi√≥n oficial");
                                    changeReputation('police', 10);
                                    addStoryUpdate("Tomo un taxi hacia la comisar√≠a. El conductor me mira por el espejo retrovisor. 'Usted no es de aqu√≠, ¬øverdad? Se nota por c√≥mo mira la ciudad.' Tiene raz√≥n. Todo ha cambiado, pero a la vez nada ha cambiado.");
                                    nextScene();
                                }
                            },
                            {
                                text: "Visitar el apartamento de Carlos primero",
                                consequences: "Directo pero peligroso. Podr√≠a encontrar evidencia importante.",
                                action: () => {
                                    addClue("Evidencia del apartamento");
                                    changeStress(10);
                                    addStoryUpdate("Decido ir directamente al apartamento de Carlos. Si algo le pas√≥, las respuestas estar√°n ah√≠. El autob√∫s me lleva por calles que reconozco pero que se sienten extra√±as, como si fueran de un sue√±o medio olvidado.");
                                    nextScene();
                                }
                            },
                            {
                                text: "Buscar a antiguos contactos en el peri√≥dico local",
                                consequences: "Cauteloso e informativo. Los periodistas siempre saben m√°s de lo que publican.",
                                action: () => {
                                    addClue("Conexiones period√≠sticas");
                                    changeReputation('media', 15);
                                    addStoryUpdate("El Diario 'La Verdad' sigue en el mismo edificio de siempre. Camino por las calles del centro, observando los cambios. Nuevos edificios, nuevos negocios, pero las mismas caras de cansancio en la gente.");
                                    nextScene();
                                }
                            }
                        ]
                    },
                    {
                        location: "Primera Investigaci√≥n",
                        description: "Comienzo mi investigaci√≥n siguiendo las pistas iniciales. Cada paso me acerca m√°s a la verdad, pero tambi√©n al peligro. La ciudad guarda secretos, y Carlos hab√≠a empezado a descubrirlos.",
                        thoughts: "Carlos no desapareci√≥ por casualidad. Hay algo m√°s grande detr√°s de esto, algo que alguien quiere mantener oculto. Puedo sentirlo en el aire, en las miradas esquivas de la gente, en el silencio inc√≥modo cuando menciono su nombre.",
                        choices: [
                            {
                                text: "Continuar la investigaci√≥n con lo que he aprendido",
                                action: () => {
                                    addClue("Patr√≥n de comportamiento sospechoso");
                                    addStoryUpdate("Las piezas comienzan a formar un patr√≥n. Carlos estaba investigando algo grande, algo que involucra a gente poderosa. Es hora de profundizar.");
                                    nextChapter();
                                }
                            }
                        ]
                    }
                ]
            },
            2: {
                title: "Primeras Pistas",
                scenes: [
                    {
                        location: "Comisar√≠a Central",
                        description: "El edificio de concreto gris parece m√°s deteriorado que antes. El sargento Morales me recibe con una mezcla de reconocimiento y desconfianza. Sus ojos evitan los m√≠os cuando menciono a Carlos.",
                        thoughts: "Morales sabe algo que no me est√° diciendo. Su nerviosismo es evidente. La forma en que tamborilea los dedos sobre el escritorio, c√≥mo evita el contacto visual... He visto esa actitud antes en gente que oculta informaci√≥n importante.",
                        dialogue: "'Carlos andaba metido en cosas peligrosas, Adri√°n. Hac√≠a preguntas que no deb√≠a hacer, a gente que no perdona. Mi consejo es que te olvides de √©l y regreses de donde viniste.'",
                        choices: [
                            {
                                text: "Presionar sobre qu√© tipo de preguntas hac√≠a Carlos",
                                consequences: "Agresivo. Podr√≠a obtener informaci√≥n valiosa pero da√±ar relaciones.",
                                action: () => {
                                    addClue("Carlos investigaba lavado de dinero", true);
                                    changeReputation('police', -10);
                                    changeStress(5);
                                    addRevelation("Morales baja la voz y mira hacia la puerta. 'Carlos estaba investigando el lavado de dinero. Ten√≠a nombres, fechas, movimientos bancarios. Demasiada informaci√≥n para su propio bien. Y creo que alguien se enter√≥.'");
                                    nextScene();
                                }
                            },
                            {
                                text: "Preguntar por el expediente oficial de la desaparici√≥n",
                                consequences: "Formal. Podr√≠a obtener acceso oficial o ser rechazado.",
                                action: () => {
                                    if (gameState.reputation.police > 60) {
                                        addClue("Expediente oficial manipulado", true);
                                        addRevelation("Morales me entrega una carpeta delgada. 'Esto es todo lo que tenemos oficialmente.' Pero noto que faltan p√°ginas, y hay evidencia clara de manipulaci√≥n en los documentos.");
                                    } else {
                                        addStoryUpdate("'No puedo darte esa informaci√≥n, Adri√°n. √ìrdenes de arriba. Lo siento.' Morales cierra la carpeta firmemente.");
                                        changeStress(5);
                                    }
                                    nextScene();
                                }
                            },
                            {
                                text: "Apelar a nuestra amistad del pasado",
                                consequences: "Emocional. Podr√≠a ablandar su actitud si a√∫n conf√≠a en m√≠.",
                                action: () => {
                                    addClue("Fotograf√≠a comprometedora");
                                    changeReputation('police', 5);
                                    gameState.flags.moralesHelped = true;
                                    addStoryUpdate("'Por los viejos tiempos, Adri√°n.' Morales saca una fotograf√≠a de su caj√≥n. 'Encontramos esto en el carro de Carlos. No est√° en el expediente oficial.' La foto muestra a Carlos reuni√©ndose con un hombre en traje que no reconozco.");
                                    nextScene();
                                }
                            }
                        ]
                    },
                    {
                        location: "Apartamento de Carlos",
                        description: "El edificio colonial en el centro hist√≥rico muestra su edad. Subo las escaleras crujientes hasta el apartamento 3B. La puerta est√° entreabierta, balance√°ndose ligeramente con la brisa que entra por la ventana rota del pasillo.",
                        thoughts: "Esto no est√° bien. Carlos nunca dejar√≠a su puerta abierta. Era paranoico con la seguridad, especialmente despu√©s de que empez√≥ a recibir esas llamadas extra√±as que me mencion√≥ en su √∫ltima conversaci√≥n.",
                        choices: [
                            {
                                text: "Buscar en el escondite secreto de nuestra infancia",
                                consequences: "Nost√°lgico. Solo yo sabr√≠a d√≥nde buscar.",
                                action: () => {
                                    addClue("USB con archivos de Carlos", true);
                                    addRevelation("Detr√°s del marco de la foto de su graduaci√≥n, encuentro un peque√±o USB y una nota con mi nombre. 'Adri√°n, si est√°s leyendo esto, significa que algo me pas√≥. En este USB est√° todo lo que descubr√≠. Conf√≠o en que har√°s lo correcto. Tu hermano, Carlos.'");
                                    gameState.flags.foundUSB = true;
                                    nextScene();
                                }
                            },
                            {
                                text: "Examinar los documentos esparcidos por el suelo",
                                consequences: "Met√≥dico. Podr√≠a encontrar pistas en lo que los intrusos dejaron atr√°s.",
                                action: () => {
                                    addClue("Lista de empresas fantasma");
                                    addRevelation("Entre los papeles esparcidos encuentro fragmentos de la investigaci√≥n de Carlos. Nombres tachados, n√∫meros de cuenta bancaria, direcciones de empresas que parecen no existir realmente. Carlos hab√≠a identificado una red compleja de lavado de dinero.");
                                    nextScene();
                                }
                            },
                            {
                                text: "Preguntar a los vecinos sobre actividad sospechosa",
                                consequences: "Social. Los vecinos podr√≠an haber visto algo importante.",
                                action: () => {
                                    addClue("Testimonio de Do√±a Carmen");
                                    changeReputation('citizens', 10);
                                    addStoryUpdate("Do√±a Carmen del 2A me recibe con caf√© y preocupaci√≥n. 'Ese muchacho Carlos andaba muy nervioso √∫ltimamente, mijo. Llegaban carros elegantes a buscarlo, y √©l siempre sal√≠a p√°lido despu√©s de esas visitas. La √∫ltima vez, hace tres d√≠as, se llevaron cajas de su apartamento.'");
                                    nextScene();
                                }
                            }
                        ]
                    },
                    {
                        location: "An√°lisis de Evidencias",
                        description: "De vuelta en mi hotel, extiendo todas las evidencias sobre la cama. Fotograf√≠as, documentos, testimonios... Las piezas del rompecabezas empiezan a formar una imagen aterradora.",
                        thoughts: "Carlos descubri√≥ algo que podr√≠a derribar a gente muy poderosa. No es solo corrupci√≥n local, es algo mucho m√°s grande. Las empresas fantasma, las transferencias bancarias, las reuniones secretas... todo apunta a una red de lavado de dinero a gran escala.",
                        choices: [
                            {
                                text: "Analizar el USB de Carlos (si lo encontr√©)",
                                condition: () => gameState.flags.foundUSB,
                                action: () => {
                                    addClue("Red de lavado internacional", true);
                                    addRevelation("El USB contiene archivos que revelan una red de lavado de dinero que conecta empresarios locales con carteles internacionales. Los nombres incluyen al alcalde, varios empresarios prominentes, y sorprendentemente, al jefe de polic√≠a.");
                                    gameState.flags.knowsFullTruth = true;
                                    nextChapter();
                                }
                            },
                            {
                                text: "Continuar con la informaci√≥n que tengo",
                                action: () => {
                                    addStoryUpdate("Aunque no tengo toda la informaci√≥n, lo que he descubierto es suficiente para saber que Carlos estaba en peligro real. Es hora de profundizar en la investigaci√≥n.");
                                    nextChapter();
                                }
                            }
                        ]
                    }
                ]
            },
            3: {
                title: "La Conspiraci√≥n",
                scenes: [
                    {
                        location: "Caf√© 'El Encuentro'",
                        description: "Una mujer me contact√≥ an√≥nimamente, diciendo que ten√≠a informaci√≥n sobre Carlos. Elena V√°squez, seg√∫n se presenta, es una contadora que trabajaba para una de las empresas que Carlos estaba investigando.",
                        thoughts: "Elena parece genuinamente asustada. Sus manos tiemblan mientras sostiene la taza de caf√©, y constantemente mira por encima del hombro. Lo que me va a decir cambiar√° todo lo que cre√≠a saber sobre esta ciudad.",
                        dialogue: "'Carlos descubri√≥ que el alcalde Mendoza, el jefe de polic√≠a Herrera y varios empresarios est√°n involucrados en una red de lavado de dinero. Tienen conexiones directas con el cartel de los Hermanos del Norte. Yo llevaba las cuentas... hasta que me di cuenta de lo que realmente estaba haciendo.'",
                        choices: [
                            {
                                text: "Pedir pruebas concretas de las acusaciones",
                                consequences: "Directo. Necesito evidencia s√≥lida para actuar.",
                                action: () => {
                                    addClue("Fotograf√≠as de reuniones secretas", true);
                                    addRevelation("Elena me entrega un sobre con fotograf√≠as de reuniones secretas entre funcionarios y conocidos narcotraficantes. 'Tom√© estas fotos como seguro de vida. Carlos ten√≠a copias tambi√©n.'");
                                    changeStress(15);
                                    nextScene();
                                }
                            },
                            {
                                text: "Preguntar d√≥nde est√° Carlos ahora",
                                consequences: "Urgente. Su vida podr√≠a estar en peligro inmediato.",
                                action: () => {
                                    addClue("Ubicaci√≥n de Carlos", true);
                                    addRevelation("Elena baja la voz hasta casi un susurro. 'Lo tienen en un almac√©n en el puerto. Almac√©n 47. Pero Adri√°n... creo que ya es demasiado tarde. Hace dos d√≠as que no se mueve nada por all√°.'");
                                    changeStress(25);
                                    gameState.flags.knowsLocation = true;
                                    nextScene();
                                }
                            },
                            {
                                text: "Preguntarle por qu√© decidi√≥ ayudarme",
                                consequences: "Cauteloso. Necesito saber si puedo confiar en ella.",
                                action: () => {
                                    addStoryUpdate("'Porque Carlos me salv√≥ la vida una vez. Cuando descubr√≠ lo que estaba pasando, quise salir, pero ellos no te dejan salir as√≠ nom√°s. Carlos me ayud√≥ a esconderme, me dio dinero para desaparecer. Le debo esto.'");
                                    changeReputation('citizens', 15);
                                    nextScene();
                                }
                            }
                        ]
                    },
                    {
                        location: "Decisi√≥n Cr√≠tica",
                        description: "Tengo informaci√≥n suficiente para exponer la conspiraci√≥n, pero Carlos sigue desaparecido y posiblemente en peligro mortal. Cada minuto cuenta, pero tambi√©n cada decisi√≥n que tome ahora determinar√° no solo mi destino, sino el de Carlos y toda la ciudad.",
                        thoughts: "Puedo publicar la historia inmediatamente y exponer a los corruptos, pero eso podr√≠a firmar la sentencia de muerte de Carlos si a√∫n est√° vivo. O puedo intentar rescatarlo primero, arriesgando que destruyan todas las pruebas y que la corrupci√≥n contin√∫e. No hay decisiones f√°ciles en este juego.",
                        choices: [
                            {
                                text: "Publicar la historia inmediatamente en todos los medios",
                                critical: true,
                                consequences: "La presi√≥n p√∫blica podr√≠a salvar a Carlos, pero tambi√©n podr√≠a acelerar su muerte.",
                                action: () => {
                                    gameState.flags.publishedStory = true;
                                    addRevelation("Env√≠o toda la informaci√≥n a contactos en medios nacionales e internacionales. En una hora, la historia est√° en primera plana. La ciudad explota en protestas, pero Carlos...");
                                    changeReputation('media', 30);
                                    changeReputation('government', -40);
                                    changeReputation('police', -30);
                                    nextChapter();
                                }
                            },
                            {
                                text: "Intentar rescatar a Carlos primero",
                                critical: true,
                                consequences: "Arriesgo todo por salvar a mi amigo, pero podr√≠a perder las pruebas.",
                                action: () => {
                                    gameState.flags.rescueAttempt = true;
                                    addRevelation("Decido arriesgar todo por salvar a mi amigo. Las pruebas no significan nada si Carlos muere. Me dirijo al puerto en la oscuridad de la noche.");
                                    changeStress(30);
                                    nextChapter();
                                }
                            },
                            {
                                text: "Contactar a la polic√≠a federal primero",
                                critical: true,
                                consequences: "Podr√≠a ser la opci√≥n m√°s segura, pero tambi√©n la m√°s lenta.",
                                action: () => {
                                    gameState.flags.contactedFeds = true;
                                    addRevelation("Contacto a un agente federal que conoc√≠a de mis d√≠as como periodista. 'Necesitamos 48 horas para montar la operaci√≥n,' me dice. Pero Carlos podr√≠a no tener 48 horas.");
                                    changeReputation('government', 20);
                                    nextChapter();
                                }
                            }
                        ]
                    }
                ]
            },
            4: {
                title: "La Confrontaci√≥n",
                scenes: [
                    {
                        location: "Camino al Puerto",
                        description: gameState.flags.rescueAttempt ? 
                            "Conduzco hacia el puerto en la oscuridad. Las luces de la ciudad brillan a lo lejos, pero aqu√≠ solo hay sombras, contenedores abandonados y el olor salado del mar mezclado con diesel." :
                            gameState.flags.publishedStory ?
                            "Despu√©s de publicar la historia, recibo una llamada de un n√∫mero desconocido. 'Si quieres ver a tu amigo vivo, ven al almac√©n 47 del puerto. Solo. Tienes una hora.'" :
                            "Los federales me contactan. 'Hemos localizado a tu amigo. Pero necesitamos que vengas con nosotros como testigo. Es la √∫nica forma de hacer esto legalmente.'",
                        thoughts: gameState.flags.rescueAttempt ?
                            "Esto podr√≠a ser una trampa, pero no puedo abandonar a Carlos. Hemos sido hermanos desde la infancia, y los hermanos no se abandonan." :
                            gameState.flags.publishedStory ?
                            "Sab√≠a que esto pasar√≠a. Al publicar la historia, forc√© su mano. Ahora tengo que enfrentar las consecuencias de mis decisiones." :
                            "Los federales parecen competentes, pero ¬øpuedo confiar en que no hay infiltrados? En esta ciudad, la corrupci√≥n llega a todos lados.",
                        choices: [
                            {
                                text: "Ir al almac√©n del puerto",
                                action: () => {
                                    addStoryUpdate("Me dirijo al puerto. El almac√©n 47 se alza como una sombra amenazante contra el cielo nocturno. No hay vuelta atr√°s.");
                                    nextScene();
                                }
                            }
                        ]
                    },
                    {
                        location: "Almac√©n 47",
                        description: "El interior del almac√©n est√° d√©bilmente iluminado por unas pocas bombillas colgantes. Encuentro a Carlos atado a una silla en el centro del espacio. Est√° vivo, pero herido. El alcalde Mendoza sale de las sombras acompa√±ado de dos hombres armados.",
                        thoughts: "Carlos levanta la vista y me ve. Sus ojos me dicen todo: sab√≠a que vendr√≠a por √©l, pero tambi√©n sabe que esto podr√≠a ser el final para ambos. Hay sangre seca en su camisa, pero est√° consciente.",
                        dialogue: "'Adri√°n V√°squez, el periodista heroico que regresa a casa.' Mendoza sonr√≠e fr√≠amente. 'Tu amigo aqu√≠ ha sido muy... persistente en sus preguntas. Pero las preguntas tienen consecuencias, como est√°s a punto de descubrir.'",
                        choices: [
                            {
                                text: "Negociar la liberaci√≥n de Carlos",
                                consequences: "Diplom√°tico pero arriesgado. Podr√≠a funcionar o ser una trampa.",
                                action: () => {
                                    if (gameState.flags.publishedStory) {
                                        addRevelation("'Ya es demasiado tarde para negociar, periodista. Tu historia ya est√° en todas partes. Los federales vienen en camino. Pero puedes acompa√±ar a tu amigo en su √∫ltimo viaje.'");
                                        changeStress(20);
                                    } else {
                                        addRevelation("'Entr√©game todas las pruebas que tienes, y tu amigo vivir√°. Tienes mi palabra.' Mendoza extiende la mano, esperando.");
                                        gameState.flags.negotiationOffered = true;
                                    }
                                    nextScene();
                                }
                            },
                            {
                                text: "Revelar que ya contact√© a las autoridades federales",
                                consequences: "Amenazante. Podr√≠a disuadirlos o acelerar la violencia.",
                                action: () => {
                                    if (gameState.flags.contactedFeds) {
                                        addRevelation("'Los federales ya vienen en camino, Mendoza. En 20 minutos este lugar estar√° rodeado.' Su expresi√≥n cambia, mostrando por primera vez algo de preocupaci√≥n.");
                                        gameState.flags.fedsComingThreat = true;
                                    } else {
                                        addRevelation("'Mentira. Si hubieras hecho eso, ya estar√≠an aqu√≠.' Mendoza sonr√≠e fr√≠amente. 'Siempre fuiste mal mentiroso, Adri√°n.'");
                                        changeStress(10);
                                    }
                                    nextScene();
                                }
                            },
                            {
                                text: "Activar discretamente la grabadora que llevo escondida",
                                consequences: "Arriesgado pero inteligente. Podr√≠a obtener una confesi√≥n.",
                                action: () => {
                                    gameState.flags.recordingStarted = true;
                                    addStoryUpdate("Discretamente activo la grabadora digital que ten√≠a escondida en mi chaqueta. Cada palabra que diga Mendoza ahora est√° siendo registrada.");
                                    nextScene();
                                }
                            }
                        ]
                    },
                    {
                        location: "El Momento de la Verdad",
                        description: "Todo se reduce a este momento. Las decisiones que he tomado a lo largo de la investigaci√≥n determinar√°n no solo mi destino y el de Carlos, sino el futuro de toda la ciudad. Mendoza est√° perdiendo la paciencia.",
                        thoughts: "Carlos me mira y asiente ligeramente. Sabe lo que tengo que hacer. Hemos llegado demasiado lejos para echarnos atr√°s ahora. La verdad tiene que salir a la luz, sin importar el costo.",
                        dialogue: "'Se acab√≥ el tiempo de charlas, periodista. O me das lo que quiero, o tu amigo y t√∫ van a tener un accidente muy lamentable en el puerto.'",
                        choices: [
                            {
                                text: "Entregar las pruebas para salvar a Carlos",
                                critical: true,
                                consequences: "Carlos vivir√°, pero la corrupci√≥n continuar√°.",
                                action: () => {
                                    gameState.flags.sacrificedEvidence = true;
                                    addRevelation("Entrego todas las pruebas que tengo. 'Carlos vivir√°, pero la verdad muere aqu√≠,' pienso mientras veo c√≥mo Mendoza quema los documentos.");
                                    nextChapter();
                                }
                            },
                            {
                                text: "Revelar que la grabaci√≥n ya est√° siendo transmitida en vivo",
                                critical: true,
                                condition: () => gameState.flags.recordingStarted,
                                consequences: "Jugada maestra, pero extremadamente peligrosa.",
                                action: () => {
                                    gameState.flags.liveTransmission = true;
                                    addRevelation("'La grabaci√≥n de esta conversaci√≥n se est√° transmitiendo en vivo a tres estaciones de noticias diferentes. Ya es demasiado tarde, Mendoza. Todo el pa√≠s est√° escuchando.'");
                                    nextChapter();
                                }
                            },
                            {
                                text: "Crear una distracci√≥n para que Carlos escape",
                                critical: true,
                                consequences: "Heroico pero probablemente fatal para m√≠.",
                                action: () => {
                                    gameState.flags.heroicSacrifice = true;
                                    addRevelation("Me lanzo contra uno de los guardias, grit√°ndole a Carlos que corra. Es mi √∫nica oportunidad de salvarlo, aunque me cueste la vida.");
                                    nextChapter();
                                }
                            }
                        ]
                    }
                ]
            },
            5: {
                title: "Resoluci√≥n",
                scenes: [
                    {
                        location: "El Desenlace",
                        description: "Los eventos de esta noche cambiar√°n la ciudad para siempre. Las consecuencias de cada decisi√≥n que tom√© se revelan ahora, en este momento final.",
                        thoughts: "Todo ha llevado a este momento. Cada elecci√≥n, cada riesgo, cada sacrificio... ahora ver√© si vali√≥ la pena.",
                        choices: [
                            {
                                text: "Ver c√≥mo termina todo",
                                action: () => {
                                    showEnding();
                                }
                            }
                        ]
                    }
                ]
            }
        };

        // Sistema de audio mejorado
        let audioContext;
        let backgroundOscillators = [];
        let gainNode;

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                createSuspenseMusic();
            } catch (e) {
                console.log("Audio no disponible en este navegador");
            }
        }

        function createSuspenseMusic() {
            if (!audioContext) return;

            // Crear m√∫ltiples osciladores para una m√∫sica m√°s rica
            const frequencies = [55, 82.5, 110, 165]; // A1, E2, A2, E3
            backgroundOscillators = [];

            gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(gameState.volume, audioContext.currentTime);
            gainNode.connect(audioContext.destination);

            frequencies.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const oscGain = audioContext.createGain();
                
                oscillator.type = index % 2 === 0 ? 'sine' : 'triangle';
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                
                oscGain.gain.setValueAtTime(0.1, audioContext.currentTime);
                
                oscillator.connect(oscGain);
                oscGain.connect(gainNode);
                
                if (gameState.musicEnabled) {
                    oscillator.start();
                    backgroundOscillators.push({ osc: oscillator, gain: oscGain, baseFreq: freq });
                }
            });

            // Crear variaciones din√°micas
            if (gameState.musicEnabled) {
                createMusicVariations();
            }
        }

        function createMusicVariations() {
            setInterval(() => {
                if (gameState.musicEnabled && audioContext && backgroundOscillators.length > 0) {
                    const time = Date.now() / 1000;
                    const stressMultiplier = 1 + (gameState.stress / 100) * 0.5;
                    
                    backgroundOscillators.forEach((osc, index) => {
                        const variation = Math.sin(time / (2 + index)) * 3 * stressMultiplier;
                        const newFreq = osc.baseFreq + variation;
                        osc.osc.frequency.setValueAtTime(newFreq, audioContext.currentTime);
                        
                        // Intensidad basada en el estr√©s
                        const intensity = 0.05 + (gameState.stress / 100) * 0.15;
                        osc.gain.gain.setValueAtTime(intensity, audioContext.currentTime);
                    });
                }
            }, 200);
        }

        function playDiscoverySound() {
            if (!audioContext || !gameState.musicEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.5);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function playTensionSound() {
            if (!audioContext || !gameState.musicEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.linearRampToValueAtTime(150, audioContext.currentTime + 1);
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        }

        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            const btn = document.getElementById('musicToggle');
            btn.classList.toggle('active');
            
            if (gameState.musicEnabled) {
                initAudio();
                btn.textContent = 'üéµ M√∫sica';
            } else {
                if (audioContext) {
                    backgroundOscillators.forEach(osc => {
                        try { osc.osc.stop(); } catch(e) {}
                    });
                    audioContext.close();
                    audioContext = null;
                    backgroundOscillators = [];
                }
                btn.textContent = 'üîá M√∫sica';
            }
        }

        function changeVolume() {
            const volumes = [0.1, 0.3, 0.5];
            const currentIndex = volumes.indexOf(gameState.volume);
            gameState.volume = volumes[(currentIndex + 1) % volumes.length];
            
            const btn = document.getElementById('volumeBtn');
            const icons = ['üîâ', 'üîä', 'üì¢'];
            btn.textContent = icons[volumes.indexOf(gameState.volume)] + ' Vol';
            
            if (gainNode) {
                gainNode.gain.setValueAtTime(gameState.volume, audioContext.currentTime);
            }
        }

        // Funciones principales del juego
        function startGame() {
            document.getElementById('titleScreen').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'grid';
            gameState.gameStarted = true;
            initAudio();
            updateDisplay();
        }

        function updateDisplay() {
            updateChapterInfo();
            updateReputation();
            updateInventory();
            updateStress();
            updateProgress();
            updateCurrentScene();
        }

        function updateChapterInfo() {
            const chapter = gameChapters[gameState.currentChapter];
            document.getElementById('chapterDisplay').textContent = `Cap√≠tulo ${gameState.currentChapter}: ${chapter.title}`;
            document.getElementById('currentChapter').textContent = gameState.currentChapter;
        }

        function updateCurrentScene() {
            const chapter = gameChapters[gameState.currentChapter];
            const scene = chapter.scenes[gameState.currentScene];
            
            document.getElementById('locationTitle').textContent = scene.location;
            
            let content = `<p>${scene.description}</p>`;
            
            if (scene.thoughts) {
                content += `<div class="inner-thought">${scene.thoughts}</div>`;
            }
            
            if (scene.dialogue) {
                content += `<div class="dialogue">${scene.dialogue}</div>`;
            }
            
            document.getElementById('storyContent').innerHTML = content;
            updateChoices(scene.choices || []);
        }

        function updateChoices(choices) {
            const container = document.getElementById('choicesContainer');
            if (choices.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-style: italic;">Contin√∫a la investigaci√≥n...</p>';
                return;
            }

            let html = '<div class="choices-title">¬øQu√© decido hacer?</div>';
            
            choices.forEach((choice, index) => {
                // Verificar condiciones si existen
                if (choice.condition && !choice.condition()) {
                    return; // Saltar esta opci√≥n si no se cumple la condici√≥n
                }
                
                const criticalClass = choice.critical ? ' critical' : '';
                html += `
                    <button class="choice-btn${criticalClass}" onclick="makeChoice(${index})">
                        ${choice.text}
                        ${choice.consequences ? `<div class="choice-consequence">${choice.consequences}</div>` : ''}
                    </button>
                `;
            });
            
            container.innerHTML = html;
        }

        function makeChoice(choiceIndex) {
            const chapter = gameChapters[gameState.currentChapter];
            const scene = chapter.scenes[gameState.currentScene];
            const availableChoices = scene.choices.filter(choice => !choice.condition || choice.condition());
            const choice = availableChoices[choiceIndex];
            
            if (choice && choice.action) {
                // Registrar la elecci√≥n
                gameState.choices.push({
                    chapter: gameState.currentChapter,
                    scene: gameState.currentScene,
                    choice: choiceIndex,
                    text: choice.text,
                    timestamp: Date.now()
                });
                
                // Ejecutar la acci√≥n
                choice.action();
                
                // Reproducir sonido si es una decisi√≥n cr√≠tica
                if (choice.critical) {
                    playTensionSound();
                }
                
                // Actualizar display despu√©s de un breve delay para efectos
                setTimeout(() => {
                    updateDisplay();
                }, 300);
            }
        }

        function nextScene() {
            const chapter = gameChapters[gameState.currentChapter];
            if (gameState.currentScene < chapter.scenes.length - 1) {
                gameState.currentScene++;
                gameState.progress += 5;
            } else {
                nextChapter();
            }
            updateDisplay();
        }

        function nextChapter() {
            if (gameState.currentChapter < Object.keys(gameChapters).length) {
                gameState.currentChapter++;
                gameState.currentScene = 0;
                gameState.progress += 15;
                updateDisplay();
            } else {
                showEnding();
            }
        }

        function addClue(clue, critical = false) {
            if (!gameState.inventory.includes(clue)) {
                gameState.inventory.push(clue);
                gameState.cluesFound++;
                gameState.truthRevealed = Math.min(100, (gameState.cluesFound / 15) * 100);
                
                if (critical) {
                    playDiscoverySound();
                }
                
                updateInventory();
                updateProgress();
            }
        }

        function addRevelation(text) {
            const content = document.getElementById('storyContent');
            content.innerHTML += `<div class="revelation">üí° REVELACI√ìN: ${text}</div>`;
            playDiscoverySound();
            changeStress(5); // Las revelaciones aumentan el estr√©s
        }

        function addStoryUpdate(text) {
            const content = document.getElementById('storyContent');
            content.innerHTML += `<div class="story-update">${text}</div>`;
        }

        function changeReputation(faction, amount) {
            gameState.reputation[faction] = Math.max(0, Math.min(100, gameState.reputation[faction] + amount));
            updateReputation();
        }

        function updateReputation() {
            Object.keys(gameState.reputation).forEach(faction => {
                const value = gameState.reputation[faction];
                const bar = document.getElementById(faction + 'Bar');
                const valueDisplay = document.getElementById(faction + 'Value');
                
                if (bar) bar.style.width = value + '%';
                if (valueDisplay) valueDisplay.textContent = value;
            });
        }

        function updateInventory() {
            const container = document.getElementById('inventory');
            container.innerHTML = '';
            
            if (gameState.inventory.length === 0) {
                container.innerHTML = '<div style="color: #888; font-style: italic; text-align: center;">Sin evidencias</div>';
                return;
            }
            
            gameState.inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inventory-item';
                if (item.includes('USB') || item.includes('Fotograf√≠as') || item.includes('Ubicaci√≥n') || item.includes('Red de lavado')) {
                    div.classList.add('critical');
                }
                div.textContent = item;
                div.title = item;
                container.appendChild(div);
            });
        }

        function changeStress(amount) {
            gameState.stress = Math.max(0, Math.min(100, gameState.stress + amount));
            updateStress();
        }

        function updateStress() {
            const bar = document.getElementById('stressBar');
            const value = document.getElementById('stressValue');
            bar.style.width = gameState.stress + '%';
            value.textContent = gameState.stress + '%';
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progressBar.style.width = gameState.progress + '%';
            progressText.textContent = gameState.progress + '%';
            
            document.getElementById('clueCount').textContent = gameState.cluesFound;
            document.getElementById('truthProgress').textContent = Math.round(gameState.truthRevealed);
        }

        function showEnding() {
            let endingTitle, endingContent, endingClass;
            
            // Determinar el final basado en las decisiones del jugador
            if (gameState.flags.liveTransmission) {
                endingTitle = "El H√©roe de la Verdad";
                endingClass = "hero";
                endingContent = `
                    <p>Tu brillante estrategia de transmitir en vivo la confesi√≥n de Mendoza cambi√≥ todo. La transmisi√≥n se volvi√≥ viral en minutos, y la presi√≥n p√∫blica fue tan intensa que los federales actuaron inmediatamente.</p>
                    <p>Carlos fue rescatado esa misma noche, y toda la red de corrupci√≥n fue desmantelada. Mendoza, el jefe de polic√≠a Herrera, y una docena de empresarios fueron arrestados. La ciudad comenz√≥ un proceso de sanaci√≥n que tomar√° a√±os, pero que finalmente hab√≠a comenzado.</p>
                    <p>T√∫ y Carlos fundaron un nuevo peri√≥dico independiente, "Memorias de Asfalto", dedicado a investigar la corrupci√≥n y dar voz a los sin voz. La ciudad que una vez los expuls√≥ ahora los celebra como h√©roes.</p>
                    <p><strong>Has logrado el mejor final posible. La verdad prevaleci√≥ y salvaste a tu amigo.</strong></p>
                `;
            } else if (gameState.flags.publishedStory && gameState.flags.knowsLocation) {
                endingTitle = "El Periodista Valiente";
                endingClass = "good";
                endingContent = `
                    <p>Tu decisi√≥n de publicar la historia primero cre√≥ la presi√≥n necesaria para que las autoridades actuaran. Aunque fue arriesgado, la estrategia funcion√≥. Los federales llegaron al almac√©n justo a tiempo para salvar a Carlos.</p>
                    <p>La mayor√≠a de los corruptos fueron arrestados, aunque algunos lograron escapar del pa√≠s. Carlos se recuper√≥ completamente de sus heridas, y juntos continuaron exponiendo la corrupci√≥n restante en la ciudad.</p>
                    <p>La ciudad cambi√≥ lentamente, pero cambi√≥. Las calles que una vez fueron testigos de tanta injusticia ahora resonaban con esperanza renovada.</p>
                    <p><strong>Lograste exponer la corrupci√≥n y salvar a Carlos. Un final heroico.</strong></p>
                `;
            } else if (gameState.flags.heroicSacrifice) {
                endingTitle = "El Sacrificio del Hermano";
                endingClass = "bittersweet";
                endingContent = `
                    <p>Tu sacrificio no fue en vano. Carlos logr√≥ escapar y, con las pruebas que hab√≠as recopilado, expuso toda la red de corrupci√≥n. Tu muerte se convirti√≥ en el catalizador que la ciudad necesitaba para despertar.</p>
                    <p>Miles de personas salieron a las calles exigiendo justicia. Tu nombre se convirti√≥ en s√≠mbolo de la lucha contra la corrupci√≥n. Carlos, devastado pero determinado, continu√≥ tu trabajo.</p>
                    <p>Un a√±o despu√©s, se inaugur√≥ el "Centro de Periodismo Investigativo Adri√°n V√°squez" en tu honor. La ciudad nunca olvid√≥ tu sacrificio.</p>
                    <p><strong>Diste tu vida por la verdad. Tu legado vivir√° para siempre.</strong></p>
                `;
            } else if (gameState.flags.sacrificedEvidence) {
                endingTitle = "El Precio de la Amistad";
                endingClass = "sad";
                endingContent = `
                    <p>Elegiste salvar a Carlos entregando todas las pruebas. Tu amigo vive, pero los corruptos siguen en el poder. Mendoza cumpli√≥ su palabra y liber√≥ a Carlos, pero tambi√©n se asegur√≥ de que nunca m√°s pudieran amenazarlo.</p>
                    <p>Ambos tuvieron que abandonar la ciudad esa misma noche. La red de corrupci√≥n continu√≥ operando, y la ciudad permaneci√≥ en las sombras. Pero Carlos vive, y para ti, eso era lo √∫nico que importaba.</p>
                    <p>A√±os despu√©s, desde el exilio, siguieron investigando y eventualmente lograron exponer parte de la corrupci√≥n, pero el da√±o ya estaba hecho.</p>
                    <p><strong>Salvaste a tu amigo, pero la justicia tuvo un precio muy alto.</strong></p>
                `;
            } else if (gameState.flags.contactedFeds && !gameState.flags.rescueAttempt) {
                endingTitle = "El Camino Seguro";
                endingClass = "neutral";
                endingContent = `
                    <p>Tu decisi√≥n de trabajar con los federales fue la m√°s segura, pero tambi√©n la m√°s lenta. Cuando finalmente llegaron al almac√©n, Carlos hab√≠a sido trasladado. Tom√≥ tres semanas m√°s encontrarlo.</p>
                    <p>Carlos sobrevivi√≥, pero con heridas permanentes. La red de corrupci√≥n fue parcialmente desmantelada, pero los peces m√°s grandes escaparon. A√∫n as√≠, lograste hacer una diferencia significativa.</p>
                    <p>La ciudad cambi√≥ gradualmente, y aunque no fue el final perfecto que esperabas, fue un final donde la justicia, aunque lenta, eventualmente lleg√≥.</p>
                    <p><strong>Elegiste el camino seguro. No todos los h√©roes necesitan ser temerarios.</strong></p>
                `;
            } else {
                endingTitle = "El Final Amargo";
                endingClass = "bad";
                endingContent = `
                    <p>A pesar de tus mejores esfuerzos, no lograste salvar a Carlos ni exponer completamente la corrupci√≥n. La ciudad sigue siendo la misma, y las memorias de asfalto guardan un secreto m√°s.</p>
                    <p>Pero tu investigaci√≥n no fue completamente en vano. Plantaste semillas de duda que alg√∫n d√≠a florecer√°n. Otros periodistas continuar√°n donde t√∫ terminaste, inspirados por tu valent√≠a.</p>
                    <p>Carlos se convirti√≥ en un m√°rtir silencioso, y su memoria impulsa a otros a continuar la lucha contra la injusticia.</p>
                    <p><strong>No todos los h√©roes tienen finales felices, pero todos dejan una marca.</strong></p>
                `;
            }

            const endingScreen = document.createElement('div');
            endingScreen.className = 'ending-screen';
            endingScreen.innerHTML = `
                <div class="ending-title">${endingTitle}</div>
                <div class="ending-content">${endingContent}</div>
                <div class="ending-stats">
                    <h3>Estad√≠sticas Finales</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <p><strong>Investigaci√≥n:</strong></p>
                            <p>‚Ä¢ Pistas encontradas: ${gameState.cluesFound}/15</p>
                            <p>‚Ä¢ Verdad revelada: ${Math.round(gameState.truthRevealed)}%</p>
                            <p>‚Ä¢ Cap√≠tulos completados: ${gameState.currentChapter}/5</p>
                        </div>
                        <div>
                            <p><strong>Estado Final:</strong></p>
                            <p>‚Ä¢ Nivel de estr√©s: ${gameState.stress}%</p>
                            <p>‚Ä¢ Decisiones tomadas: ${gameState.choices.length}</p>
                            <p>‚Ä¢ Decisiones cr√≠ticas: ${gameState.choices.filter(c => gameChapters[c.chapter]?.scenes[c.scene]?.choices[c.choice]?.critical).length}</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <p><strong>Reputaci√≥n Final:</strong></p>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; font-size: 0.9rem;">
                            <div>Polic√≠a: ${gameState.reputation.police}</div>
                            <div>Medios: ${gameState.reputation.media}</div>
                            <div>Ciudadanos: ${gameState.reputation.citizens}</div>
                            <div>Pandillas: ${gameState.reputation.gangs}</div>
                            <div>Gobierno: ${gameState.reputation.government}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <button class="restart-btn" onclick="restartGame()">Jugar de Nuevo</button>
                    <button class="restart-btn" onclick="showChoicesSummary()">Ver Decisiones</button>
                </div>
            `;

            document.body.appendChild(endingScreen);
            
            // Cambiar la m√∫sica para el final
            if (audioContext && gameState.musicEnabled) {
                // Detener m√∫sica de suspenso y crear m√∫sica de final
                backgroundOscillators.forEach(osc => {
                    try { osc.osc.stop(); } catch(e) {}
                });
                createEndingMusic();
            }
        }

        function createEndingMusic() {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 5);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 5);
        }

        function showChoicesSummary() {
            const summaryScreen = document.createElement('div');
            summaryScreen.className = 'ending-screen';
            summaryScreen.style.zIndex = '300';
            
            let choicesHtml = '<h2>Resumen de Decisiones</h2><div style="text-align: left; max-width: 600px;">';
            
            gameState.choices.forEach((choice, index) => {
                const chapter = gameChapters[choice.chapter];
                const scene = chapter.scenes[choice.scene];
                const choiceData = scene.choices[choice.choice];
                
                choicesHtml += `
                    <div style="margin: 15px 0; padding: 15px; background: rgba(255,107,53,0.1); border-radius: 8px;">
                        <strong>Cap√≠tulo ${choice.chapter}: ${chapter.title}</strong><br>
                        <em>${scene.location}</em><br>
                        <span style="color: #f39c12;">${choiceData.text}</span>
                    </div>
                `;
            });
            
            choicesHtml += '</div>';
            
            summaryScreen.innerHTML = `
                ${choicesHtml}
                <button class="restart-btn" onclick="this.parentElement.remove()">Cerrar</button>
            `;
            
            document.body.appendChild(summaryScreen);
        }

        function restartGame() {
            // Detener audio
            if (audioContext) {
                backgroundOscillators.forEach(osc => {
                    try { osc.osc.stop(); } catch(e) {}
                });
                audioContext.close();
                audioContext = null;
                backgroundOscillators = [];
            }
            
            // Recargar la p√°gina
            location.reload();
        }

        // Inicializaci√≥n del juego
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar controles de audio
            document.getElementById('musicToggle').addEventListener('click', toggleMusic);
            document.getElementById('volumeBtn').addEventListener('click', changeVolume);
            
            // Inicializar display si el juego ya comenz√≥
            if (gameState.gameStarted) {
                updateDisplay();
            }
        });

        // Prevenir que el usuario se vaya accidentalmente
        window.addEventListener('beforeunload', function(e) {
            if (gameState.gameStarted && gameState.currentChapter < 5) {
                e.preventDefault();
                e.returnValue = '¬øEst√°s seguro de que quieres abandonar la investigaci√≥n?';
            }
        });

        // Funci√≥n para guardar progreso en localStorage (bonus)
        function saveGame() {
            localStorage.setItem('memoriasDeAsfalto_save', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('memoriasDeAsfalto_save');
            if (saved) {
                gameState = JSON.parse(saved);
                updateDisplay();
                return true;
            }
            return false;
        }

        // Auto-guardar cada vez que se toma una decisi√≥n
        function autoSave() {
            if (gameState.gameStarted) {
                saveGame();
            }
        }

        // Llamar auto-guardar despu√©s de cada elecci√≥n
        const originalMakeChoice = makeChoice;
        makeChoice = function(choiceIndex) {
            originalMakeChoice(choiceIndex);
            autoSave();
        };
    </script>
</body>
</html>